var margin={top:20,right:30,bottom:30,left:40},width=600-margin.left-margin.right,height=300-margin.top-margin.bottom,parseDate=d3.time.format("%Y-%m-%d").parse,x=d3.time.scale().range([0,width]),yVisitsScale=d3.scale.linear().range([height,0]),ySubscribersScale=d3.scale.linear().range([height,0]),yConvScale=d3.scale.linear().range([height,0]),xAxis=d3.svg.axis().scale(x).orient("bottom"),yVisitsAxis=d3.svg.axis().scale(yVisitsScale).orient("left"),ySubscribersAxis=d3.svg.axis().scale(ySubscribersScale).orient("right"),yConvAxis=d3.svg.axis().scale(yConvScale).orient("right").tickFormat(function(n){return parseInt(n*1e3+"")/10+"%"}),visitsLine=d3.svg.line().interpolate("basis").x(function(n){return x(n.date)}).y(function(n){return yVisitsScale(n.visits)}),convLine=d3.svg.line().interpolate("basis").x(function(n){return x(n.date)}).y(function(n){return yConvScale(n.subscribers/n.visits)}),subscribersLine=d3.svg.line().interpolate("basis").x(function(n){return x(n.day)}).y(function(n){return ySubscribersScale(n.subscribers)}),makeVisitsLine=function(){var n={};return function(t){var r=t[0].country+"__"+t[0].service,i=n[r],u;return!i?(u=makeVisitsScale(t),i=d3.svg.line().interpolate("basis").x(function(n){return x(n.date)}).y(function(n){return u(n.visits)}),n[r]=i,i):i}}(),makeVisitsScale=function(){var n={};return function(t){var r=t[0].country+"__"+t[0].service,i=n[r];return!i?(i=d3.scale.linear().range([height,0]).domain([0,d3.max(t,function(n){return n.visits})]),n[i]=i,i):i}}();d3.csv("/googleplay/gplay.csv",function(n){var u=this,f,i,r,t,e;n=n.map(function(n){return n.date=parseDate(n.date),["visits","installs","knownoc","launches","confirmation_displayed","confirmation_rejected","subscribers"].forEach(function(t){return n[t]=+n[t]}),n}),x.domain(d3.extent(n,function(n){return n.date})),yConvScale.domain([0,d3.max(n.filter(function(n){return n.visits>100}),function(n){return n.subscribers/n.visits})]),yVisitsScale.domain([0,d3.max(n,function(n){return n.visits})]),f=d3.nest().key(function(n){return n.country}).key(function(n){return n.service}).entries(n),i=d3.select("body").append("section").selectAll("div.country").data(f).enter().append("div").attr("class","country"),i.append("h2").text(function(n){return n.key}),r=i.selectAll("div.service").data(function(n){return n.values}).enter().append("div").attr("class","service"),r.append("h3").text(function(n){return n.key}),t=r.append("svg").attr("width",width+margin.left+margin.right).attr("height",height+margin.top+margin.bottom).append("g").attr("transform","translate("+margin.left+","+margin.top+")").datum(function(n){return n.values}),t.append("path").attr("class","line conversion").attr("d",function(n){return convLine.apply(u,[n])}),t.append("path").attr("class","line visits").attr("d",function(n){return makeVisitsLine(n).apply(u,[n])}),t.append("g").attr("class","x axis").attr("transform","translate(0,"+height+")").call(xAxis),t.append("g").attr("class","y axis conversion").attr("transform","translate("+width+",0)").call(yConvAxis).append("text").attr("transform","rotate(-90)").attr("y",-10).attr("dy",".71em").style("text-anchor","end").text("Conversion"),e=d3.svg.axis().scale(yVisitsScale).orient("left"),t.append("g").attr("class","y axis").call(e).append("text").attr("transform","rotate(-40)").attr("y",-15).attr("dy",".81em").style("text-anchor","end").text("Visits")})