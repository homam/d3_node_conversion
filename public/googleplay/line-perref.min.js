var margin={top:20,right:30,bottom:30,left:40},width=700-margin.left-margin.right,height=300-margin.top-margin.bottom,parseDate=d3.time.format("%Y-%m-%d").parse,bisectDate=d3.bisector(function(n){return n.date.valueOf()}),makeYScale=function(){return d3.scale.linear().range([height,0])},x=d3.time.scale().range([0,width]),yVisitsScale=makeYScale(),ySubscribersScale=makeYScale(),yConvScale=makeYScale(),yConfDisplayRatioScale=makeYScale(),yConfDisplayScale=makeYScale(),ratioFormat=function(n){return parseInt(n*1e3+"")/10+"%"},xAxis=d3.svg.axis().scale(x).orient("bottom"),yVisitsAxis=d3.svg.axis().scale(yVisitsScale).orient("left"),ySubscribersAxis=d3.svg.axis().scale(ySubscribersScale).orient("right"),yConvAxis=d3.svg.axis().scale(yConvScale).orient("right").tickFormat(ratioFormat),yConfDisplayAxis=d3.svg.axis().scale(yConfDisplayScale).orient("right"),makeLine=function(){return d3.svg.line().interpolate("basis").x(function(n){return x(n.date)})},visitsLine=makeLine().y(function(n){return yVisitsScale(n.visits)}),convLine=makeLine().y(function(n){return yConvScale(n.subscribers/n.visits)}),subscribersLine=makeLine().y(function(n){return ySubscribersScale(n.subscribers)}),confDisplayRatioLine=makeLine().y(function(n){return yConfDisplayRatioScale(n.confirmation_displayed/(n.launches||1))}),confDisplayLine=makeLine().y(function(n){return yConfDisplayScale(n.confirmation_displayed)}),smooth;d3.csv("/googleplay/gplay-perref.csv",function(n){n=n.map(function(n){return n.date=parseDate(n.date),["visits","installs","knownoc","launches","confirmation_displayed","confirmation_rejected","subscribers"].forEach(function(t){return n[t]=+n[t]}),n}),x.domain(d3.extent(n,function(n){return n.date})),_(n).chain().groupBy(function(n){return n.country}).forEach(function(n,t){_(n).chain().groupBy(function(n){return n.service}).forEach(function(n,i){_(n).chain().groupBy(function(n){return n.referrer}).forEach(function(n,r){var o,e,u,f,s;if(yConvScale.domain([0,d3.max(n.filter(function(n){return n.visits>100}),function(n){return n.subscribers/n.visits})]),yVisitsScale.domain([0,d3.max(n,function(n){return n.visits})]),yConfDisplayScale.domain([0,d3.max(n,function(n){return n.confirmation_displayed})]),o=n.map(function(n){return n.visits}).reduce(function(n,t){return n+t}),!(o<500)){n=smooth(n,7),e=d3.select("body").append("section"),e.append("h2").text(t+" "+i+" "+r),u=e.append("svg").attr("width",width+margin.left+margin.right).attr("height",height+margin.top+margin.bottom).append("g").attr("transform","translate("+margin.left+","+margin.top+")").datum(n),u.append("path").attr("class","line visits").attr("d",visitsLine),u.append("path").attr("class","line conversion").attr("d",convLine),u.append("path").attr("class","line confDisplayRatio").attr("d",confDisplayRatioLine),u.append("path").attr("class","line confDisplay").attr("d",confDisplayLine),u.append("g").attr("class","x axis").attr("transform","translate(0,"+height+")").call(xAxis),u.append("g").attr("class","y axis conversion").attr("transform","translate("+width+",0)").call(yConvAxis).append("text").attr("transform","rotate(-90)").attr("y",-10).attr("dy",".71em").style("text-anchor","end").text("Conversion"),u.append("g").attr("class","y axis confDisplay").attr("transform","translate(20,0)").call(yConfDisplayAxis).append("text").attr("transform","rotate(-90)").attr("y",-10).attr("dy",".71em").style("text-anchor","end").text("Confirmation Displays"),u.append("g").attr("class","y axis visits").call(yVisitsAxis).append("text").attr("transform","rotate(-40)").attr("y",-15).attr("dy",".81em").style("text-anchor","end").text("Visits"),f=u.append("g").attr("class","focus").style("display","none"),f.append("text").attr("x",9).attr("dy",".35em"),s=function(){var t=x.invert(d3.mouse(this)[0]),i=n.filter(function(n){return Math.abs(n.date-t)<864e5});console.log(i);return;var r,u};u.append("rect").attr("class","overlay").attr("width",width).attr("height",height).on("mouseover",function(){f.style("display",null)}).on("mouseout",function(){f.style("display","none")})}})})})}),smooth=function(n,t){var i=n.map(function(n){return _.clone(n)}),r=function(n){return _(n).reduce(function(n,t){return n+t},0)},u=function(n){return r(n)/n.length};return i.map(function(n,r){var e=i.slice(r,r+t),f;for(f in n)"number"==typeof n[f]&&(n[f]=u(e.map(function(n){return n[f]})));return n})}