var margin={top:20,right:30,bottom:30,left:40},width=430-margin.left-margin.right,height=300-margin.top-margin.bottom,parseDate=d3.time.format("%m/%d/%Y").parse,x=d3.time.scale().range([0,width]),yVisitsScale=d3.scale.linear().range([height,0]),ySubscribersScale=d3.scale.linear().range([height,0]),yConvScale=d3.scale.linear().range([height,0]),xAxis=d3.svg.axis().scale(x).orient("bottom"),yVisitsAxis=d3.svg.axis().scale(yVisitsScale).orient("left"),ySubscribersAxis=d3.svg.axis().scale(ySubscribersScale).orient("right"),yConvAxis=d3.svg.axis().scale(yConvScale).orient("right").tickFormat(function(n){return parseInt(n*1e3+"")/10+"%"}),visitsLine=d3.svg.line().interpolate("basis").x(function(n){return x(n.day)}).y(function(n){return yVisitsScale(n.visits)}),convLine=d3.svg.line().interpolate("basis").x(function(n){return x(n.day)}).y(function(n){return yConvScale(n.subscribers/n.visits)}),subscribersLine=d3.svg.line().interpolate("basis").x(function(n){return x(n.day)}).y(function(n){return ySubscribersScale(n.subscribers)});d3.csv("/linkpin/Iraq_PIN_LinkPIN_Dummy.csv",function(n){var e=this,f,i,r,u,t;n.forEach(function(n){n.day=parseDate(n.Day),n.page=n.Page.split("^")[0],n.type=n.Page.split("^")[1],n.nonPin={visits:+n.NONPIN_Visits,submissions:+n.NONPIN_Submissions,subscribers:+n.NONPIN_Subscribers},n.pin={visits:+n.PIN_Visits,submissions:+n.PIN_Submissions,subscribers:+n.PIN_Subscribers},n.subscribers=n.pin.subscribers+n.nonPin.subscribers,n.visits=n.pin.visits+n.nonPin.visits}),n=_(n.map(function(n){return[{subMethod:"Non-PIN Sub Methods",visits:n.nonPin.visits,submissions:n.nonPin.submissions,subscribers:n.nonPin.subscribers,type:n.type,day:n.day,jDay:JSON.stringify(n.day),page:n.page,Page:n.Page},{subMethod:"PIN and LinkPIN Sub Methods",visits:n.pin.visits,submissions:n.pin.submissions,subscribers:n.pin.subscribers,type:n.type,day:n.day,jDay:JSON.stringify(n.day),page:n.page,Page:n.Page}]})).flatten(),console.log(n),f=n.filter(function(t){return t.Page==n[0].Page}),x.domain(d3.extent(f,function(n){return n.day})),yVisitsScale.domain([0,d3.max(n,function(n){return n.visits})]),ySubscribersScale.domain([0,d3.max(n,function(n){return n.subscribers*2})]),yConvScale.domain([0,d3.max(n,function(n){return n.subscribers/n.visits})]),i=d3.nest().key(function(n){return n.page}).key(function(n){return n.subMethod}).key(function(n){return n.type}).entries(n),console.log(i),r=d3.select("body").append("section").selectAll("div.page").data(i).enter().append("div").attr("class","page"),r.append("h2").text(function(n){return n.key}),u=r.selectAll("div.subMethod").data(function(n){return n.values}).enter().append("div").attr("class","subMethod"),u.append("h3").text(function(n){return n.key}),t=u.append("svg").attr("width",width+margin.left+margin.right).attr("height",height+margin.top+margin.bottom).append("g").attr("transform","translate("+margin.left+","+margin.top+")").datum(function(n){return n.values}),["PIN","LinkPIN"].forEach(function(n){var i=this;t.append("path").attr("class","line visits "+n).attr("d",function(t){return visitsLine.apply(i,[_(t).filter(function(t){return t.key==n})[0].values])}),t.append("path").attr("class","line conversion "+n).attr("d",function(t){return convLine.apply(i,[_(t).filter(function(t){return t.key==n})[0].values])})}),t.append("path").attr("class","line subscribers").attr("d",function(n){return subscribersLine.apply(e,[_(n[0].values.map(function(n){return n.jDay})).union(n[1].values.map(function(n){return n.jDay})).map(function(t){var i=n[0].values.filter(function(n){return n.jDay==t})[0],r=n[1].values.filter(function(n){return n.jDay==t})[0];return{subscribers:(!i?0:i.subscribers)+(!r?0:r.subscribers),day:!i?r.day:i.day}})])}),t.append("g").attr("class","x axis").attr("transform","translate(0,"+height+")").call(xAxis),t.append("g").attr("class","y axis").call(yVisitsAxis).append("text").attr("transform","rotate(-40)").attr("y",-15).attr("dy",".81em").style("text-anchor","end").text("Visits"),t.append("g").attr("class","y axis subscribers").attr("transform","translate(0,0)").call(ySubscribersAxis).append("text").attr("transform","rotate(-40) translate(60,40)").style("text-anchor","end").text("Subscribers"),t.append("g").attr("class","y axis conversion").attr("transform","translate("+width+",0)").call(yConvAxis).append("text").attr("transform","rotate(-90)").attr("y",-10).attr("dy",".71em").style("text-anchor","end").text("Conversion")})