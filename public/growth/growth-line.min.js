var margin={top:20,right:30,bottom:30,left:40},width=830-margin.left-margin.right,height=800-margin.top-margin.bottom,parseDate=d3.time.format("%m/%d/%Y").parse,color=d3.scale.category20(),xScale=d3.time.scale().range([0,width]),yScale=d3.scale.linear().range([height,0]),xAxis=d3.svg.axis().scale(xScale).orient("bottom"),yAxis=d3.svg.axis().scale(yScale).orient("left"),subsLine=d3.svg.line().interpolate("basis").x(function(n){return xScale(n.day)}).y(function(n){return yScale(n.Subs)}),subsArea=d3.svg.area().interpolate("basis").x(function(n){return xScale(n.day)}).y0(function(n){return yScale(n.y0)}).y1(function(n){return yScale(n.y0+n.y)}),stack=d3.layout.stack().values(function(n){return n.values}),subMethodNames=["Direct Wap","WEB Pin","Direct SMS","Web SMS","Wap SMS","Click Tag","Link Click","Java App","Link Pin","Wap Pin","Android","GooglePlay"];d3.csv("/growth/du_bbay.csv",function(n){var t,r;n.forEach(function(n){return n.day=parseDate(n.Day),n.Subs=parseInt(n.Subs),subMethodNames.forEach(function(t){n[t]=+n[t]}),n}),subMethodNames=_.chain(subMethodNames).map(function(t){return{name:t,total:_(n.map(function(n){return n[t]})).reduce(function(n,t){return n+t},0)}}).filter(function(n){return n.total>0}).sortBy(function(n){return-n.total}).map(function(n){return n.name}).value(),t=n,color.domain(subMethodNames),xScale.domain(d3.extent(t,function(n){return n.day})),yScale.domain([0,d3.max(t,function(n){return n.Subs})]);var u=stack(color.domain().map(function(n){return{name:n,values:t.map(function(t){return{day:t.day,y:t[n]}})}})),f=d3.select("body").append("svg").attr("width",width+margin.left+margin.right).attr("height",height+margin.top+margin.bottom),i=f.append("g").attr("transform","translate("+margin.left+","+margin.top+")"),e=i.selectAll(".subMethod").data(u).enter().append("g").attr("class",function(n){return"subMethod "+n.name});e.append("path").attr("class","area subs").attr("d",function(n){return subsArea(n.values)}).style("fill",function(n){return color(n.name)}),i.append("g").attr("class","x axis").attr("transform","translate(0,"+height+")").call(xAxis),i.append("g").attr("class","y axis").call(yAxis).append("text").attr("transform","rotate(-40)").attr("y",15).attr("dy",".81em").style("text-anchor","end").text("Visits"),r=i.selectAll(".legend").data(color.domain().slice().reverse()).enter().append("g").attr("class","legend").attr("transform",function(n,t){return"translate(0,"+t*20+")"}),r.append("rect").attr("x",width-18).attr("width",18).attr("height",18).style("fill",color),r.append("text").attr("x",width-24).attr("y",9).attr("dy",".35em").style("text-anchor","end").text(function(n){return n})})