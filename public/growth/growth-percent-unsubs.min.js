var margin={top:100,right:30,bottom:30,left:40},width=830-margin.left-margin.right,height=920-margin.top-margin.bottom,parseDate=d3.time.format("%m/%d/%Y").parse,color=d3.scale.category20(),xScale=d3.time.scale().range([0,width]),yScaleSubs=d3.scale.linear().range([height/2,0]),xAxis=d3.svg.axis().scale(xScale).orient("bottom"),yAxisSubs=d3.svg.axis().scale(yScaleSubs).orient("left"),subsArea=d3.svg.area().interpolate("basis").x(function(n){return xScale(n.day)}).y0(function(n){return yScaleSubs(n.y0)}).y1(function(n){return yScaleSubs(n.y0+n.y)}),stack=d3.layout.stack().values(function(n){return n.values}),subMethodNames=["Direct Wap","WEB Pin","Direct SMS","Web SMS","Wap SMS","Click Tag","Link Click","Java App","Link Pin","Wap Pin","Android","GooglePlay"];d3.csv("/growth/du_bbay.csv",function(n){var t,e,f,r;n.forEach(function(n){return n.day=parseDate(n.Day),n.Subs=parseInt(n.Subs),n.Unsubs=+n["Un Subs"],subMethodNames.forEach(function(t){n[t]=+n[t]}),n}),subMethodNames=_.chain(subMethodNames).map(function(t){return{name:t,total:_(n.map(function(n){return n[t]})).reduce(function(n,t){return n+t},0)}}).filter(function(n){return n.total>0}).sortBy(function(n){return-n.total}).map(function(n){return n.name}).value(),t=n,color.domain(subMethodNames),xScale.domain(d3.extent(t,function(n){return n.day})),e=d3.max([d3.max(t,function(n){return n.Subs}),d3.max(t,function(n){return n.Unsubs})]),yScaleSubs.domain([0,1]);var o=stack(color.domain().map(function(n){return{name:n,values:t.map(function(t){var i=_(subMethodNames.map(function(n){return t[n]})).reduce(function(n,t){return n+t},0);return{day:t.day,y:t[n]/i}})}})),s=d3.svg.axis().scale(yScaleSubs).orient("left").tickFormat(function(n){return n*100}),u=d3.select("body").append("svg").attr("width",width+margin.left+margin.right).attr("height",height+margin.top+margin.bottom),i=u.append("g").attr("transform","translate("+margin.left+","+margin.top+")");i.selectAll(".subMethod").data(o).enter().append("g").attr("class",function(n){return"subMethod "+n.name}).append("path").attr("class","area subs").attr("d",function(n){return subsArea(n.values)}).style("fill",function(n){return color(n.name)}),i.append("g").attr("class","x axis").attr("transform","translate(0,"+height/2+")").call(xAxis),i.append("g").attr("class","y axis").call(s).append("text").attr("transform","rotate(-90)").attr("y",5).attr("dy",".81em").style("text-anchor","end").text("Sub Methods"),f=u.append("g").attr("transform","rotate(-90) translate(-30,590)"),r=f.selectAll(".legend").data(color.domain().slice().reverse()).enter().append("g").attr("class","legend").attr("transform",function(n,t){return"translate(0,"+t*20+")"}),r.append("rect").attr("x",0).attr("width",18).attr("height",18).style("fill",color),r.append("text").attr("x",-10).attr("y",9).attr("dy",".35em").style("text-anchor","end").style("fill",color).text(function(n){return n})})